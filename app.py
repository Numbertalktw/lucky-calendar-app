st.write("ğŸŸ¢ æˆåŠŸå•Ÿå‹•")

import streamlit as st
import datetime
import pandas as pd
from io import BytesIO
import calendar
from openpyxl.styles import Alignment, Font, PatternFill, Border, Side

# ===== ä¸»æ—¥æ•¸èˆ‡å¹¸é‹ç‰©ä»¶è³‡æ–™ =====
day_meaning = {}

lucky_map = {
    1: {"è‰²": "ğŸ”´ ç´…è‰²", "æ°´æ™¶": "ç´…ç‘ªç‘™", "å°ç‰©": "åŸå­ç­†"},
    2: {"è‰²": "ğŸŸ  æ©˜è‰²", "æ°´æ™¶": "å¤ªé™½çŸ³", "å°ç‰©": "æœˆäº®åŠé£¾"},
    3: {"è‰²": "ğŸŸ¡ é»ƒè‰²", "æ°´æ™¶": "é»ƒæ°´æ™¶", "å°ç‰©": "ç´™è† å¸¶"},
    4: {"è‰²": "ğŸŸ¢ ç¶ è‰²", "æ°´æ™¶": "ç¶ å¹½éˆ", "å°ç‰©": "æ–¹å½¢çŸ³é ­"},
    5: {"è‰²": "ğŸ”µ æ·ºè—è‰²", "æ°´æ™¶": "æ‹‰åˆ©ç‘ª", "å°ç‰©": "äº¤é€šç¥¨å¡"},
    6: {"è‰²": "ğŸ”· é›è‰²", "æ°´æ™¶": "é’é‡‘çŸ³", "å°ç‰©": "æ„›å¿ƒåŠé£¾"},
    7: {"è‰²": "ğŸŸ£ ç´«è‰²", "æ°´æ™¶": "ç´«æ°´æ™¶", "å°ç‰©": "æ›¸ç±¤"},
    8: {"è‰²": "ğŸ’— ç²‰è‰²", "æ°´æ™¶": "ç²‰æ™¶", "å°ç‰©": "é‹¼ç­†"},
    9: {"è‰²": "âšª ç™½è‰²", "æ°´æ™¶": "ç™½æ°´æ™¶", "å°ç‰©": "å°é¦™åŒ…"},
}

# ===== å°æ‡‰çµ„åˆæ•¸æŒ‡å¼•å­—å…¸ =====
flowing_day_guidance_map = {
    "11/2": "èˆ‡è‡ªå·±çš„å…§åœ¨éˆæ€§é€£çµï¼Œæ‰“é–‹å¿ƒçœ¼å¾å¿ƒå»çœ‹æ¸…æ¥šèƒŒå¾Œçš„çœŸç›¸ã€‚ä»Šå¤©é©åˆä¿æŒè€å¿ƒï¼Œå°ˆæ³¨ä¸”ç´°è†©åœ°èˆ‡äººåˆä½œï¼Œå…±å‰µå’Œè«§å’Œæˆé•·ã€‚",
    "12/3": "å‰µæ„çš„æƒ³æ³•å’Œèƒ½é‡æ­£åœ¨æ¹§ç¾ï¼Œç”¨ç´”ç²¹ä¸”å‹•è½çš„æ–¹å¼å‚³éå‡ºä¾†ã€‚ä»Šå¤©æ˜¯å’Œè¨˜éŒ„éˆæ„Ÿï¼Œæˆ–å…¬é–‹å‘ä»–äººè¡¨é”è‡ªå·±çš„æƒ³æ³•å’Œè§€é»ã€‚",
    "13/4": "è®“æƒ³æ³•ä¸å†åªæ˜¯æƒ³åƒï¼Œæ˜¯æ™‚å€™è¨­æ³•è½å¯¦åˆ°è‡ªå·±çš„ç¾å¯¦ç”Ÿæ´»ä¸­ã€‚ä»Šå¤©é©åˆæ’°å¯«è¨ˆç•«ã€å®‰æ’æµç¨‹ã€ç†æ¸…è„ˆçµ¡ï¼Œè®“ä¸€åˆ‡æ›´æ˜ç¢ºã€‚",
    "14/5": "è½‰åŒ–ç¾æœ‰çš„ç‹€æ…‹ï¼Œå¾å›ºæœ‰å’Œå‡æ»¯çš„å·¥ä½œã€é—œä¿‚ä¸­è§£è„«ï¼Œå°‡å…§åœ¨çŸ›ç›¾çš„èƒ½é‡ï¼Œè½‰è®Šç‚ºç”Ÿå‘½çš„å¼µåŠ›ã€‚é©åˆæ‰“ç ´å¸¸è¦ã€å‹‡æ•¢é¢å°å…§åœ¨æ¸´æœ›ã€‚",
    "15/6": "æœƒç‰¹åˆ¥æ¸´æœ›èˆ‡æŸäººæ·±å…¥äº¤è«‡ã€åˆ†äº«å¿ƒäº‹ã€‚é€™ä¹Ÿæ˜¯å€‹é©åˆåœ¨å·¥ä½œä¸­èˆ‡å¤¥ä¼´æºé€šç†æƒ³ã€æ¸…æ™°è¡¨é”ä½ æœŸæœ›æˆæœçš„æ—¥å­ã€‚",
    "16/7": "æ•´ç†å…§åœ¨èˆ‡å­¸ç¿’çš„å¥½æ™‚æ©Ÿï¼Œæ„Ÿåˆ°ç²¾ç¥æ¸™æ•£æ™‚ï¼Œéœ€è¦è®“è‡ªå·±éœä¸‹ä¾†ã€‚ä»Šå¤©é©åˆå¯«ä½œã€é–±è®€ï¼Œè®“æ€ç·’é‡æ–°æ­¸ä½ã€‚",
    "17/8": "æœƒç‰¹åˆ¥æƒ³è™•ç†èˆ‡é‡‘éŒ¢ã€æœå‹™æˆ–ç®¡ç†ç›¸é—œçš„å•é¡Œã€‚é€™ä¹Ÿæ˜¯æ”¶ç©«æˆæœå’Œé—œä¿‚çš„æ™‚åˆ»ï¼Œé©åˆè¬€åŠƒã€æ‰“äº¤é“ï¼Œè¿½æ±‚æ›´é«˜å“è³ªèˆ‡æ•ˆç‡ã€‚",
    "18/9": "åœ¨æ–°éšæ®µä¾†è‡¨ä¹‹å‰ï¼Œå…ˆå­¸æœƒæ”¾ä¸‹ã€å‘Šåˆ¥èˆ‡çµæŸï¼Œè®“èˆŠæ•…äº‹ç•«ä¸Šå¥é»ã€‚ä»Šå¤©é©åˆç†æ¸…é—œä¿‚ã€æ‰¿èªéŒ¯èª¤ã€çµ¦äºˆåŸè«’èˆ‡è¡¨é”æ„Ÿè¬ä¹‹æ„ã€‚",
    "19/10/1": "æœƒç™¼ç¾è‡ªå·±æ¯”å¹³æ™‚æ›´å®¹æ˜“æ¥æ”¶åˆ°ä¾†è‡ªå…§åœ¨æˆ–å¤–åœ¨çš„éˆæ„Ÿï¼Œé©åˆå†¥æƒ³ã€è¨˜éŒ„å¤¢å¢ƒï¼Œæˆ–å±•é–‹å…·æœ‰éˆæ€§æ„åœ–çš„è¨ˆç•«ã€‚",
    "20/2": "å…§åœ¨å¤–åœ¨éƒ½å°‡è¿ä¾†ç¿»è½‰å¼çš„æ”¹è®Šï¼Œè—‰æ­¤æ™‚å€™è®“è‡ªå·±é€éä¸åŒè§’åº¦çš„äº¤æ›ï¼Œå»æ´è¦‹æ›´åŠ æ¸…æ™°çš„çœŸç›¸ã€‚",
    "21/3": "ä»Šå¤©é»å­å’Œæƒ³æ³•æœƒæ¯”å¹³å¸¸è¦å¤šï¼Œå¥½å¥½é‹ç”¨æºé€šå’Œè¡¨é”ä¾†å‰µé€ ã€‚é©åˆç°¡å ±ã€å‰µä½œã€æ•™å­¸ã€ç¤¾äº¤æ´»å‹•ã€‚",
    "22/4": "å¤šä»»å‹™ã€å¤šè®Šå‹•çš„ä¸€å¤©ã€‚ä¿æŒè€å¿ƒèˆ‡è¡Œå‹•åŠ›ï¼ŒåŒæ™‚ç…§é¡§å¥½è‡ªå·±çš„èº«é«”èˆ‡æƒ…ç·’ç‹€æ…‹ã€‚",
    "23/5": "æ˜¯æ™‚å€™æ¥æ”¶æ–°çš„åˆºæ¿€å’Œè®Šå‹•ï¼Œéç¨‹é›£å…æœƒå—åˆ°ä¸€äº›é˜»åŠ›ï¼Œä½†é€™åŒæ™‚ä¹Ÿæ˜¯åœ¨è€ƒé©—è‡ªå·±æ˜¯å¦æœ‰è¶³å¤ å‹‡æ°£ã€‚",
    "24/6": "é—œå¿ƒè‡ªå·±èº«é‚Šè¦ªè¿‘çš„å®¶äººæœ‹å‹ï¼Œæ‰¿è«¾èˆ‡è²¬ä»»æ˜¯ä»Šå¤©çš„ä¸»é¡Œã€‚é©åˆæ•´ç†å±…å®¶ç©ºé–“ã€æ”¾é¬†å’Œç…§é¡§è‡ªå·±çš„èº«é«”ã€‚",
    "25/7": "å°ˆæ³¨åœ¨è‡ªå·±çš„äº‹æƒ…ä¸Šï¼Œåœ¨é€™ç•¶ä¸­æ‰¾å›å…§åœ¨çš„å¹³éœèˆ‡å’Œè«§æ„Ÿã€‚é©åˆé€²è¡Œå€‹äººè¨ˆç•«æˆ–é–±è®€ã€å¯«ä½œã€éœåç·´ç¿’ã€‚",
    "26/8": "å¼·åŒ–è‡ªä¿¡èˆ‡æ“”ç•¶ï¼Œé©åˆæ¥ä¸‹è²¬ä»»ã€è™•ç†è²¡å‹™ã€è¨­å®šä¸‹ä¸€æ­¥ç­–ç•¥ã€‚",
    "27/9": "é€éçœŸç†çœ‹è¦‹çœŸç›¸ï¼Œæœ‰æ„è­˜åœ°æ”¾ä¸‹æ˜¯ä»Šå¤©çš„é‡é»ã€‚é©åˆå¾äº‹å¿—å·¥ã€æœå‹™ã€æˆ–ç™‚ç™’æ€§çš„å°è«‡èˆ‡é‡‹æ”¾ã€‚",
    "28/10/1": "æœ‰å¼·å¤§é¡¯åŒ–åŠ›èˆ‡åŸ·è¡ŒåŠ›çš„æ—¥å­ã€‚ä¿æŒå‹™å¯¦ã€è² è²¬çš„æ…‹åº¦ï¼Œé©åˆæ€è€ƒä¸€å€‹é å¤§çš„ç›®æ¨™ï¼Œå’Œè¦åŠƒè²¡å‹™ç›¸é—œçš„äº‹æƒ…ã€‚",
    "29/11/2": "é€éå‚¾è½å’Œè§€å¯Ÿï¼Œå¾æ›´é«˜ä¹ƒè‡³æ–¼æ™ºæ…§å’Œéˆæ€§çš„å±¤æ¬¡ï¼Œä¾†è§£è®€ä¾†åˆ°è‡ªå·±çœ¼å‰çš„äº‹æƒ…ã€‚é©åˆè™•ç†æ–‡æ›¸å·¥ä½œã€æ‰‹ä½œã€åˆä½œã€‚",
    "30/3": "ä»Šå¤©çš„ä¸»é¡Œæ˜¯æºé€šèˆ‡å”èª¿ï¼Œé‹ç”¨å‰µæ„ä¾†åšåŒ…è£å’Œè¡ŒéŠ·ï¼Œè®“æƒ³æ³•å’Œé»å­å¾—ä»¥è¡¨ç¾å‡ºä¾†ã€‚é©åˆåšç™¼æƒ³ã€è—è¡“å‰µä½œã€è¨­è¨ˆã€éŠ·å”®ç›¸é—œçš„äº‹æƒ…ã€‚",
    "31/4": "å‰µé€ ä¸­è˜Šå«çµæ§‹ï¼Œéˆæ„Ÿéœ€è¦è¢«è¦åŠƒä¾†è½åœ°ã€‚ä»Šå¤©é©åˆåˆ¶å®šç« ç¨‹ã€æµç¨‹ã€æˆ–é–‹å§‹é•·æœŸå‰µä½œè¨ˆç•«ã€‚",
    "32/5": "ä¿æŒéˆæ´»å’Œå½ˆæ€§ï¼Œæ•é–‹å¿ƒé‡‹æ”¾å’Œæ¥æ”¶æ„›ï¼Œæœ‰æ©Ÿæœƒçªç ´æˆ–ç¢°ä¸Šæœ‰è¶£çš„é‚‚é€…ã€‚é©åˆæ—…éŠã€é™Œç”Ÿé–‹ç™¼ã€è·³è„«èˆ’é©åœˆã€‚",
    "33/6": "ç”¨å‰µæ„ã€å¥½ç©çš„æ–¹å¼å»æœå‹™å’Œé—œæ„›ï¼Œé©åˆé—œæ³¨å®¶åº­ã€å­©å­ï¼Œé€²è¡Œæ·±åº¦å°è©±ï¼Œé€™æ˜¯ä¸€å€‹é‡‹æ”¾å£“æŠ‘èˆ‡å‚³éæ„›çš„å¥½æ™‚æ©Ÿã€‚",
    "34/7": "ä»Šæ—¥æœƒæƒ³ç¨è™•åæ€ï¼Œæ³¨æ„æƒ…ç·’ç®¡æ§ã€‚é©åˆå›é¡§å’Œæ•´ç†æ€ç·’ã€å­¸ç¿’å¸æ”¶æ–°çŸ¥ï¼Œç›´è¦ºå’Œéˆæ„Ÿå°‡å¾å¯§éœèˆ‡å¹³éœä¸­åˆ°ä¾†ã€‚",
    "35/8": "æ¨é€²èˆ‡æ“´å¼µçš„æ—¥å­ï¼Œçµåˆå‰µæ„èˆ‡å•†æ¥­é ­è…¦ã€‚é©åˆé€²è¡Œå·¥ä½œæ¥­å‹™æ¨å±•ã€æŠ•è³‡ã€é–‹å‰µå’Œæ”¶ç©«äººè„ˆèˆ‡è²¡å¯Œè³‡æºã€‚",
    "36/9": "åœ¨ç†æƒ³èˆ‡ç¾å¯¦ä¹‹é–“å–å¾—å¹³è¡¡é»ï¼Œé€éæœå‹™èˆ‡å¥‰ç»å¹«åŠ©ä»–äººã€‚ä»Šå¤©æ˜¯æ¥µå…·å’Œè«§æ„Ÿçš„ä¸€å¤©ï¼Œé©åˆè—è¡“ã€ç™‚ç™’ã€æˆ–åœ¨é—œä¿‚ä¸­çµ¦äºˆæº«æŸ”é™ªä¼´ã€‚",
    "37/10/1": "é©æ™‚ç«™å‡ºä¾†ç‚ºè‡ªå·±ç™¼è²ï¼Œæˆ–æˆç‚ºçœŸç†çš„ä»£è¨€äººï¼Œå‹‡æ•¢å±•ç¾å’Œå±•é–‹æ–°çš„è¡Œå‹•ã€‚",
    "38/11/2": "é‹ç”¨ä¹‹å‰ç´¯ç©çš„ç”Ÿå‘½ç¶“é©—ä¾†å”åŠ©èº«é‚Šé‡è¦çš„å¤¥ä¼´ã€å®¶äººï¼Œç”¨é¢¨è¶£çš„æ–¹å¼é»å‡ºå•é¡Œï¼Œè®“ä¸€åˆ‡ç¹¼çºŒé€²è¡Œã€‚",
    "39/12/3": "è²éŸ³å’Œèªè¨€æ˜¯å…·æœ‰éå¸¸å¤§èƒ½é‡çš„ï¼Œç”¨è²éŸ³å’Œè©±èªå»è®šç¾è‡ªå·±å’Œä»–äººã€‚é©åˆçµ±æ•´æƒ³æ³•ã€ç”¢ç”Ÿå…±è­˜ã€èŠå¤©è«‡å¿ƒã€‚",
    "40/4": "ä»¥åœ˜ä¸”ç©©å›ºç‚ºå‰æï¼Œå°ˆæ³¨æ–¼æ›´æ–°ç¾æœ‰çš„æ¡†æ¶å’Œæ¶æ§‹ï¼Œå†æ¬¡å»ºç«‹æ–°çš„ä¸”æ‰å¯¦çš„çµæ§‹ï¼Œé¿å…éåº¦å¢¨å®ˆè¦å‰‡ã€‚",
    "41/5": "ç©©å®šä¸­å°‹æ±‚è‡ªç”±ã€‚çªç ´å¸¸è¦ï¼Œå­¸æœƒåœ¨è®Šå‹•ä¸­ä¿æŒå¹³è¡¡èˆ‡å°ç”Ÿå‘½çš„ç†±å¿±ï¼Œéˆæ´»æ‡‰å°ã€‚",
    "42/6": "è¦çŸ©ç´€å¾‹éœ€èˆ‡äººéš›é—œä¿‚ä¸¦é‡ï¼ŒæŠŠå®ˆè¦å¾‹çš„åŒæ™‚ï¼Œä¹Ÿéœ€è€ƒé‡åˆ°æ„Ÿæ€§å±¤é¢çš„äº‹æƒ…ï¼Œèˆ‡å®¶äººæˆ–åœ˜éšŠå…±é€²ã€‚",
    "43/7": "æœ‰å¼·å¤§çš„çµ„ç¹”å’Œåˆ†æèƒ½åŠ›ï¼Œéœ€ç•™æ„è‡ªå·±çš„æƒ…ç·’æ§ç®¡èˆ‡èªªè©±çš„æ–¹å¼ã€‚é©åˆé‡çœ‹éå»ä¸ç†è§£çš„é—œä¿‚ã€æ›¸ç±ï¼Œé‡æ–°æ‰¾å‡ºé‡é»ã€‚",
    "44/8": "ä»Šå¤©ä½ å°‡å…·å¼·å¤§åŸ·è¡ŒåŠ›èˆ‡å½±éŸ¿åŠ›ï¼Œç¹¼çºŒæ‰ç©©è…³æ­¥çš„åŒæ™‚ï¼Œä¸€é‚Šç­‰å¾…æ©Ÿé‹èˆ‡çªç ´å£ï¼Œéœ€é¿å…å›ºåŸ·è€Œå¿½ç•¥ä»–äººè²éŸ³ã€‚",
    "45/9": "é‹ç”¨ç†æ€§ã€é‚è¼¯çš„æ–¹å¼ï¼Œæ·±å…¥æ ¸å¿ƒå»çœæ€ï¼Œä»¥æˆå°±è‡ªèº«æ™ºæ…§ã€‚é©åˆåšæ®µæ¨é›¢ã€å¹«åŠ©å’Œæˆå°±ä»–äººã€‚",
    "46/10/1": "æˆç‚ºå·¥ä½œæˆ–å®¶åº­ä¸­çš„å¸¶å‹•è€…ï¼Œå±•ç¾çµ„ç¹”åœ˜éšŠåŠåˆä½œèƒ½åŠ›ï¼Œèšç„¦ç›®æ¨™ç‚ºè²¬ä»»èˆ‡æ‰¿è«¾ä»˜è«¸è¡Œå‹•ã€‚",
    "47/11/2": "æ‰®æ¼”å¥½ä¸€å€‹ç©©å®šä¸”å¯é çš„é—œéµè§’è‰²ï¼Œåœ¨é‡è¦æ™‚åˆ»å”åŠ©ä»–äººéé—œã€‚é©åˆæ‰¾èˆ‡äººé€²è¡Œåˆä½œã€è¿‘ä¸€æ­¥æ‹‰è¿‘é—œä¿‚ã€‚",
    "48/12/3": "åœ¨å¯©æ…è©•ä¼°ã€ç•™æ„ç´°ç¯€çš„å‰æä¸‹ï¼Œåšå‡ºä¸€äº›è®ŠåŒ–å’Œå¯Œæœ‰å‰µæ„çš„æ±ºç­–ã€‚é©åˆåšè©•ä¼°å’Œèª¿æŸ¥ã€åˆ¶å®šè¡ŒéŠ·æ–¹æ¡ˆã€‚",
    "49/13/4": "åœ¨ç©©å®šçš„åŸºç¤ä¸‹ï¼Œåšå‡ºå–æ¨å’Œæ›´æ–°ç•¶ä¸‹çš„ç‹€æ…‹ï¼Œé€éæ™ºæ…§æå‡åˆ°æ›´é«˜çš„å¢ƒç•Œã€‚é©åˆå¸¶é ˜åœ˜éšŠã€æˆ–è™•ç†å®¶åº­å•é¡Œã€‚",
    "50/5": "åœ¨è®Šå‹•èˆ‡ä¸å¹³ç©©ä¹‹ä¸­ï¼Œéš±è—è‘—æ„æƒ³ä¸åˆ°çš„æ©Ÿæœƒï¼Œäº«å—å’ŒæŠŠæ¡é€™ç¾å¥½çš„æ™‚åˆ»ã€‚é©åˆé–‹æ‹“æ–°é ˜åŸŸæˆ–æ‹“å±•çœ¼ç•Œå’Œäººéš›é—œä¿‚ã€‚",
    "51/6": "å‹‡æ•¢çš„é¢å°è‡ªå·±çš„ææ‡¼å’Œå‰µå‚·ï¼Œå”¯æœ‰èˆ‡è‡ªå·±å’Œè§£æ‰èƒ½çœŸæ­£è„«é›¢æƒ…ç·’ä¸Šçš„æŸç¸›ã€‚é©åˆå¾äº‹è‡ªæˆ‘ç™‚ç™’ã€é™ªä¼´ä»–äººè«‡å¿ƒã€‚",
    "52/7": "å¾äº‹æƒ…çš„æ ¸å¿ƒåˆ‡å…¥ï¼Œä¸€å±¤ä¸€å±¤çš„å‰–æå’Œç†è§£ï¼Œæœ€çµ‚å°‡çœ‹è¦‹çœŸç›¸ã€‚ä»Šå¤©é©åˆç¨è™•æ·±æ€ï¼Œè§€å¯Ÿæƒ…ç·’æ³¢å‹•èƒŒå¾Œçš„åŸå› ã€‚",
    "53/8": "æœ‰æ©Ÿæœƒå‰µé€ å¯è§€çš„è²¡å¯Œæ”¶å…¥æˆ–äººç”Ÿç¶“é©—ï¼Œä¿æŒé–‹æ”¾å¤šæ¥è§¸æœƒæœ‰æ”¶ç©«ã€‚é©åˆå»åšé«”é©—ã€æ¨å»£è‡ªå·±çš„æœå‹™æˆ–å•†å“ã€‚",
    "54/9": "æ˜¯æ™‚å€™å¾æ¼«ç„¡ç›®çš„æ…¢æ…¢æ”¶æ–‚èšç„¦ï¼Œæœ‰æ„è­˜åœ°æ”¾ä¸‹æ„Ÿè¬éå¾€è‡ªå·±çš„åŠªåŠ›ã€‚é©åˆè®“äº‹æƒ…å’Œé—œä¿‚å‘Šä¸€æ®µè½ï¼Œæº–å‚™é€²å…¥ä¸‹å€‹éšæ®µã€‚",
    "55/10/1": "æ¥µåº¦çš„å¤–æ”¾å’Œè‡ªæˆ‘å±•ç¾ï¼ŒèƒŒå¾Œç”¢ç”Ÿçš„æ˜¯å†’çŠ¯èˆ‡ä¾µç•¥ã€‚ç•™æ„è¡Œè»Šç‹€æ…‹ã€ç·´ç¿’ä¿æŒå°ˆæ³¨ã€‚",
    "56/11/2": "å€‹äººçš„è‡ªç”±èˆ‡æ‰¿è«¾ä¹‹é–“å½¢æˆçŸ›ç›¾é—œä¿‚ï¼Œå¦‚ä½•è·³è„«äºŒå…ƒå°ç«‹çš„æ€ç¶­æ¨¡å¼ï¼Œæ˜¯ä»Šå¤©çš„é‡é»ã€‚",
    "57/12/3": "ç•™æ„è‡ªå·±å…§åœ¨çš„æƒ³æ³•å’Œç›´è¦ºï¼Œå¾ˆå¤šæ–¹å‘å’Œç­”æ¡ˆéƒ½åœ¨é‚£è£¡ã€‚é©åˆå˜—è©¦æ–°åª’ä»‹ã€æ–°å¯«ä½œã€æ–°è¡¨æ¼”å½¢å¼æˆ–å­¸ç¿’æ–°èªè¨€ã€‚",
    "58/13/4": "åœ¨å„ç¨®è®Šå‹•çš„æƒ…æ³ä¸­ï¼Œæ•´åˆå‡ºæ–°æµç¨‹å’Œè¦å‰‡ã€‚ä»Šå¤©å¯è¨­å®šè¡Œç¨‹ã€ä¿®æ­£çµæ§‹ã€æ‰¾å›ç©©å®šç¯€å¥ã€‚",
    "59/14/5": "å¯Œæœ‰æŒ‘æˆ°æ€§çš„ä¸€å¤©ï¼Œéå»æ‰€å­¸å°‡åœ¨æ­¤è¿ä¾†æŒ‘æˆ°ã€è½‰åŒ–èˆ‡æˆé•·ã€‚å»ºè­°ä¿æœ‰éˆæ´»çš„å½ˆæ€§ï¼Œä¹Ÿéœ€è¬¹æ…é¢å°éå»æœªè§£è­°é¡Œã€‚"
}

def reduce_to_digit(n):
    while n > 9:
        n = sum(int(x) for x in str(n))
    return n

def format_layers(total):
    mid = sum(int(x) for x in str(total))
    return f"{total}/{mid}/{reduce_to_digit(mid)}" if mid > 9 else f"{total}/{mid}"

def get_flowing_year_ref(query_date, bday):
    query_date = query_date.date() if hasattr(query_date, "date") else query_date
    cutoff = datetime.date(query_date.year, bday.month, bday.day)
    return query_date.year - 1 if query_date < cutoff else query_date.year

def get_flowing_month_ref(query_date, birthday):
    query_date = query_date.date() if hasattr(query_date, "date") else query_date
    if query_date.day < birthday.day:
        return query_date.month - 1 if query_date.month > 1 else 12
    return query_date.month

def get_flowing_day_guidance(flowing_day_str):
    return flowing_day_guidance_map.get(flowing_day_str, "")

def style_excel(df):
    output = BytesIO()
    with pd.ExcelWriter(output, engine="openpyxl") as writer:
        df.to_excel(writer, index=False, sheet_name="æµå¹´æœˆæ›†")
        workbook = writer.book
        worksheet = workbook["æµå¹´æœˆæ›†"]
        header_font = Font(size=12, bold=True, color="FFFFFF")
        header_fill = PatternFill(start_color="4F81BD", end_color="4F81BD", fill_type="solid")
        header_alignment = Alignment(horizontal="center", vertical="center")
        for idx, column in enumerate(df.columns):
            worksheet.column_dimensions[chr(65 + idx)].width = 15
        for cell in worksheet[1]:
            cell.font = header_font
            cell.fill = header_fill
            cell.alignment = header_alignment
        thin_border = Border(left=Side(style='thin'), right=Side(style='thin'),
                             top=Side(style='thin'), bottom=Side(style='thin'))
        for row in worksheet.iter_rows():
            for cell in row:
                cell.border = thin_border
                cell.alignment = Alignment(horizontal="center", vertical="center")
        for row in worksheet.iter_rows():
            worksheet.row_dimensions[row[0].row].height = 35
    return output

st.set_page_config(page_title="æ¨‚è¦ºè£½æ‰€ç”Ÿå‘½éˆæ•¸", layout="centered")
st.title("ğŸ§­ æ¨‚è¦ºè£½æ‰€ç”Ÿå‘½éˆæ•¸")
st.markdown("åœ¨æ•¸å­—ä¹‹ä¸­ï¼Œ\næˆ‘å€‘èˆ‡è‡ªå·±ä¸æœŸè€Œé‡ã€‚\n**Be true, be you â€” è®“éˆé­‚ï¼Œè‡ªåœ¨å‘¼å¸ã€‚**")

birthday = st.date_input("è«‹è¼¸å…¥ç”Ÿæ—¥", value=datetime.date(1990, 1, 1), min_value=datetime.date(1900, 1, 1))
target_year = st.number_input("è«‹é¸æ“‡å¹´ä»½", min_value=1900, max_value=2100, value=datetime.datetime.now().year)
target_month = st.selectbox("è«‹é¸æ“‡æœˆä»½", list(range(1, 13)), index=datetime.datetime.now().month - 1)

if st.button("ğŸ‰ ç”¢ç”Ÿæ—¥æ›†å»ºè­°è¡¨"):
    _, last_day = calendar.monthrange(target_year, target_month)
    days = pd.date_range(start=datetime.date(target_year, target_month, 1),
                         end=datetime.date(target_year, target_month, last_day))
    data = []
    for d in days:
        fd_total = sum(int(x) for x in f"{birthday.year}{birthday.month:02}{d.day:02}")
        flowing_day = format_layers(fd_total)
        main_number = reduce_to_digit(fd_total)
        meaning = day_meaning.get(main_number, {})
        lucky = lucky_map.get(main_number, {})
        guidance = get_flowing_day_guidance(flowing_day)
        year_ref = get_flowing_year_ref(d, birthday)
        fy_total = sum(int(x) for x in f"{year_ref}{birthday.month:02}{birthday.day:02}")
        flowing_year = format_layers(fy_total)
        fm_ref = get_flowing_month_ref(d, birthday)
        fm_total = sum(int(x) for x in f"{birthday.year}{fm_ref:02}{birthday.day:02}")
        flowing_month = format_layers(fm_total)
        date_str = d.strftime("%Y-%m-%d")
        weekday_str = d.strftime("%A")
        data.append({
            "æ—¥æœŸ": date_str,
            "æ˜ŸæœŸ": weekday_str,
            "æµå¹´": flowing_year,
            "æµæœˆ": flowing_month,
            "æµæ—¥": flowing_day,
            "é‹å‹¢æŒ‡æ•¸": meaning.get("æ˜Ÿ", ""),
            "æŒ‡å¼•": guidance,
            "å¹¸é‹è‰²": lucky.get("è‰²", ""),
            "æ°´æ™¶": lucky.get("æ°´æ™¶", ""),
            "å¹¸é‹å°ç‰©": lucky.get("å°ç‰©", "")
        })
    df = pd.DataFrame(data)
    st.dataframe(df)
    file_name = f"LuckyCalendar_{target_year}_{str(target_month).zfill(2)}.xlsx"
    title = "æ¨‚è¦ºè£½æ‰€ç”Ÿå‘½éˆæ•¸"
    subtitle = "åœ¨æ•¸å­—ä¹‹ä¸­ï¼Œæˆ‘å€‘èˆ‡è‡ªå·±ä¸æœŸè€Œé‡ã€‚Be true, be you â€” è®“éˆé­‚ï¼Œè‡ªåœ¨å‘¼å¸ã€‚"
    if not df.empty and df.dropna(how='all').shape[0] > 0:
        output = style_excel(df)
        st.markdown(f"### {title}")
        st.markdown(f"**{subtitle}**")
        st.download_button(
            "ğŸ“¥ é»æ­¤ä¸‹è¼‰ " + file_name.replace(".xlsx", " å¹´éˆæ•¸æµæ—¥å»ºè­°è¡¨ï¼ˆä¸‰å±¤åŠ ç¸½æ–œç·šç‰ˆï¼‰"),
            data=output.getvalue(),
            file_name=file_name,
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
    else:
        st.warning("âš ï¸ ç„¡æ³•åŒ¯å‡º Excelï¼šç›®å‰è³‡æ–™ç‚ºç©ºï¼Œè«‹å…ˆç”¢ç”Ÿæ—¥æ›†è³‡æ–™")
